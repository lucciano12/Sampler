<div class="container-fluid d-flex flex-column">

  <!-- HEADER -->
  <div class="header">
    <div class="container-fluid px-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="logo">Sampler</div>

        <div class="search-container">
          <input type="text" class="search-input" placeholder="Buscar..." [formControl]="q">
          <i class="bi bi-search" style="color: #999; font-size: 1.2rem;"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="container-fluid px-4">
    <div class="filter-section">
      <i class="bi bi-vinyl icon-sampler"></i>

      <input type="text" class="filter-input" placeholder="Buscar por título, artista, fuente" [formControl]="q"
        autocomplete="off">

      <select class="filter-select" [formControl]="fuente">
        <option value="todas">Todas</option>
        <option value="Spotify">Spotify</option>
        <option value="YouTube">YouTube</option>
      </select>
    </div>
  </div>

  <!-- ESTADO DE CARGA / ERROR -->
  <div class="container-fluid px-4" *ngIf="loading || errorMsg || (filtered.length === 0 && !loading)">
    <div *ngIf="loading" class="alert alert-secondary">Cargando…</div>
    <div *ngIf="!loading && errorMsg" class="alert alert-danger">{{ errorMsg }}</div>
    <div *ngIf="!loading && !errorMsg && filtered.length === 0" class="alert alert-warning">Sin resultados</div>
  </div>


  <!-- Grid de Cards -->
  <div *ngIf="!loading && !errorMsg" class="grid-container">
    <div *ngFor="let s of filtered" class="card h-100 shadow-sm" (click)="abrirDetalle(s)" style="cursor: pointer;">

      <!-- Portada -->
      <div class="card-image">
        <img [src]="s.portada || 'assets/placeholder.png'" [alt]="s.titulo" loading="lazy"
          onerror="this.src='https://placehold.co/400x400?text=No+Cover'">

        <!-- NUEVO: Botón zoom (+) -->
        <button class="zoom-btn" (click)="openZoomModal(s.portada, s.titulo); $event.stopPropagation()"
          [attr.aria-label]="'Ampliar imagen: ' + s.titulo">
          <i class="bi bi-plus-lg"></i>
        </button>

        <span class="source-tag" [class]="s.fuente.toLowerCase()">
          {{ s.fuente }}
        </span>
      </div>


      <!-- Contenido Card -->
      <div class="card-content">
        <h3>{{ s.titulo }}</h3>
        <p class="artist">{{ s.artista }}</p>
        <p class="description">{{ s.descripcion }}</p>

        <a href="#" class="btn-link" (click)="abrirDetalle(s); $event.preventDefault(); $event.stopPropagation()">
          Ver Detalles
        </a>
      </div>
    </div>
  </div>

  <!-- ZOOM MODAL -->
  <div class="zoom-backdrop" *ngIf="zoomModalOpen" (click)="closeZoomOnBackdropClick($event)">
    <div class="zoom-modal">
      <button class="zoom-close-btn" (click)="closeZoomModal()" aria-label="Cerrar zoom">
        <i class="bi bi-x-lg"></i>
      </button>

      <img [src]="zoomImage!" [alt]="zoomTitle || 'Zoom'">
    </div>
  </div>


  <!-- Offcanvas (Detalle) -->
  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasDetalle"
    aria-labelledby="offcanvasDetalleLabel">
    <div class="offcanvas-header border-bottom border-secondary">
      <h5 class="offcanvas-title" id="offcanvasDetalleLabel">{{ sampleSel?.titulo || 'Detalle' }}</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">

      <!-- Portada en grande en el offcanvas -->
      <div class="text-center mb-4" *ngIf="sampleSel?.portada">
        <img [src]="sampleSel?.portada" class="img-fluid rounded shadow" style="max-height: 250px;" alt="Portada">
      </div>

      <ul class="nav nav-tabs nav-fill mb-3 border-secondary" role="tablist">
        <li class="nav-item">
          <button class="nav-link active text-white" data-bs-toggle="tab" data-bs-target="#tab-plataformas"
            role="tab">Plataformas</button>
        </li>
        <li class="nav-item">
          <button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tab-metadatos"
            role="tab">Info</button>
        </li>
        <li class="nav-item">
          <button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#tab-comentarios"
            role="tab">Comentarios</button>
        </li>
      </ul>

      <div class="tab-content flex-grow-1 overflow-auto">
        <!-- Tab: Plataformas -->
        <div class="tab-pane fade show active" id="tab-plataformas" role="tabpanel">
          <div class="list-group list-group-flush">
            <!-- Si hay array de plataformas -->
            <ng-container *ngFor="let p of sampleSel?.plataformas">
              <a [href]="p.url" target="_blank"
                class="list-group-item list-group-item-action list-group-item-dark d-flex justify-content-between align-items-center mb-2 rounded">
                <span><i class="bi bi-play-circle-fill me-2"></i>Escuchar en {{ p.nombre }}</span>
                <span class="badge bg-primary rounded-pill">{{ p.tipo }}</span>
              </a>
            </ng-container>

            <!-- Fallback si solo existe el enlace principal -->
            <div *ngIf="!sampleSel?.plataformas?.length && sampleSel?.enlace">
              <a [href]="sampleSel?.enlace" target="_blank"
                class="list-group-item list-group-item-action list-group-item-dark d-flex justify-content-between align-items-center rounded">
                <span><i class="bi bi-box-arrow-up-right me-2"></i>Escuchar en {{ sampleSel?.fuente }}</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Tab: Metadatos -->
        <div class="tab-pane fade" id="tab-metadatos" role="tabpanel">
          <dl class="row small">
            <dt class="col-sm-4 text-secondary">Artista</dt>
            <dd class="col-sm-8">{{ sampleSel?.artista }}</dd>
            <dt class="col-sm-4 text-secondary">Key</dt>
            <dd class="col-sm-8">{{ sampleSel?.key || '—' }}</dd>
            <dt class="col-sm-4 text-secondary">Tempo</dt>
            <dd class="col-sm-8">{{ sampleSel?.tempo || '—' }}</dd>
            <dt class="col-sm-4 text-secondary">Género</dt>
            <dd class="col-sm-8">{{ sampleSel?.genero || '—' }}</dd>
            <dt class="col-sm-4 text-secondary">Estilo</dt>
            <dd class="col-sm-8">{{ sampleSel?.estilo || '—' }}</dd>
            <dt class="col-sm-4 text-secondary">Descripción</dt>
            <dd class="col-sm-8">{{ sampleSel?.descripcion || '—' }}</dd>
          </dl>
        </div>

        <!-- Tab: Comentarios -->
        <div class="tab-pane fade" id="tab-comentarios" role="tabpanel">
          <div class="list-group list-group-flush" *ngIf="sampleSel?.comentarios?.length; else noCom">
            <div class="list-group-item list-group-item-dark mb-2 rounded" *ngFor="let c of sampleSel?.comentarios">
              <div class="fw-bold text-info small">{{ c.usuario }}</div>
              <div class="text-light small">{{ c.texto }}</div>
            </div>
          </div>
          <ng-template #noCom>
            <p class="text-secondary text-center mt-3">Sin comentarios.</p>
          </ng-template>
        </div>
      </div>
    </div>
  </div>